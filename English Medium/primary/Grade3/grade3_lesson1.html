<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathLanka - Grade 3 Lesson 2: එකතු කිරීම (සංකලනය)</title>
    <meta name="description" content="Learn addition for Grade 3 with interactive examples and a fun Addition Speed Challenge game on MathLanka.">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS configuration - MUST be after the CDN script
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#2563eb",
                        secondary: "#1e40af",
                        accent: "#f59e0b",
                        dark: "#1e293b",
                        light: "#f8fafc"
                    },
                    fontFamily: {
                        sans: ['"Segoe UI"', 'Roboto', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
        }
        .lesson-icon {
            font-size: 3rem;
            color: #2563eb;
        }
        .addition-problem-column {
            background-color: #ecfdf5; /* green-50 */
            border: 2px solid #34d399; /* green-400 */
            border-radius: 0.75rem;
            padding: 1rem;
            display: inline-block;
            margin: 0.5rem;
            font-family: 'Roboto Mono', monospace;
            font-size: 2rem;
            font-weight: bold;
            color: #065f46; /* green-800 */
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            line-height: 1.2;
            min-width: 120px;
        }
        .underline-problem {
            border-bottom: 3px solid #065f46;
            display: inline-block;
            width: 80%; /* Adjusted for column format */
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Game specific styles */
        #speedChallengeGame {
            background: linear-gradient(to bottom, #e0f2fe, #f0f9ff); /* Light blue gradient */
            border: 5px solid #2563eb;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.2);
            padding: 1.5rem;
            margin: 0 auto;
            max-width: 700px;
            text-align: center;
        }
        .game-header {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .game-stat {
            background-color: #dbeafe; /* blue-100 */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            font-weight: bold;
            color: #1e40af;
        }
        .problem-display {
            font-size: 3.5rem;
            font-weight: extrabold;
            color: #1e293b;
            margin-bottom: 2rem;
        }
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 0 auto;
            max-width: 400px;
        }
        .option-button {
            background-color: #f59e0b; /* accent */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .option-button:hover {
            background-color: #e38200;
            transform: translateY(-2px);
        }
        .option-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .option-button.correct-feedback {
            background-color: #10b981; /* green-600 */
        }
        .option-button.incorrect-feedback {
            background-color: #ef4444; /* red-600 */
        }
        .game-feedback-message {
            font-size: 1.6rem;
            font-weight: bold;
            margin-top: 1.5rem;
            min-height: 40px; /* Prevent layout shift */
        }
        .game-control-buttons {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .game-control-buttons button {
            background-color: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .game-control-buttons button:hover {
            background-color: #1e40af;
        }
        .game-control-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Custom message box for alert() replacement */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 400px;
        }
        .custom-modal-content h3 {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .custom-modal-content p {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
        }
        .custom-modal-content button {
            background-color: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .custom-modal-content button:hover {
            background-color: #1e40af;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header with Navigation -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl">ML</div>
                <span class="text-xl font-bold text-blue-600">MathLanka</span>
            </div>
            <div class="hidden md:flex space-x-6">
                <a href="../index.html#features" class="text-gray-700 hover:text-blue-600 font-medium">Features</a>
                <a href="../index.html#courses" class="text-gray-700 hover:text-blue-600 font-medium">Courses</a>
                <a href="../index.html#games" class="text-gray-700 hover:text-blue-600 font-medium">Games</a>
                <a href="../index.html#about" class="text-gray-700 hover:text-blue-600 font-medium">About</a>
            </div>
            <div class="flex items-center space-x-4">
                <a href="../login.html" class="hidden md:block text-gray-700 hover:text-blue-600 font-medium">Login</a>
                <a href="../signup.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-300">Sign Up</a>
                <button class="md:hidden text-gray-700">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- Lesson Content Section -->
    <section class="py-16 bg-gradient-to-br from-indigo-50 to-blue-100 min-h-screen">
        <div class="container mx-auto px-4 max-w-4xl bg-white rounded-xl shadow-lg p-8 md:p-12">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">Lesson 2 (Grade 3): එකතු කිරීම (සංකලනය)</h1>
            <p class="text-center text-gray-600 text-lg mb-8">අපි දැන් ඉලක්කම් එකතු කිරීමේ අලුත් ක්‍රම සහ විශාල සංඛ්‍යා එකතු කරන්නේ කොහොමද කියලා ඉගෙනගමු!</p>
            <p class="text-center text-gray-600 text-lg mb-8">Let's learn new ways to add numbers and how to add larger numbers!</p>

            <div class="space-y-10">
                <!-- Concept 1: Addition of 2-digit numbers without regrouping -->
                <div class="flex flex-col md:flex-row items-center gap-6 p-6 bg-gray-50 rounded-lg shadow-sm">
                    <div class="md:w-1/3 flex justify-center items-center">
                        <i class="fas fa-plus-square lesson-icon text-green-600"></i>
                    </div>
                    <div class="md:w-2/3 text-center md:text-left">
                        <h3 class="text-2xl font-bold text-green-700 mb-2">ඉලක්කම් දෙකේ සංඛ්‍යා එකතු කිරීම (නොකැඩී) - Adding 2-digit Numbers (No Regrouping)</h3>
                        <p class="text-gray-700 text-lg">අපි මුලින්ම එකේ තැනේ ඉලක්කම් එකතු කරමු. ඊට පස්සේ දහයේ තැනේ ඉලක්කම් එකතු කරමු.</p>
                        <p class="text-gray-700 text-lg mt-2">First, add the ones digits. Then, add the tens digits.</p>
                        <div class="flex justify-center md:justify-start gap-4 mt-4">
                            <div class="addition-problem-column">
                                <span class="block">25</span>
                                <span class="block">+ 32</span>
                                <span class="underline-problem"></span>
                                <span class="block">57</span>
                            </div>
                            <div class="addition-problem-column">
                                <span class="block">41</span>
                                <span class="block">+ 18</span>
                                <span class="underline-problem"></span>
                                <span class="block">59</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Concept 2: Addition of 2-digit numbers with regrouping -->
                <div class="flex flex-col md:flex-row items-center gap-6 p-6 bg-gray-50 rounded-lg shadow-sm">
                    <div class="md:w-1/3 flex justify-center items-center">
                        <i class="fas fa-hand-holding-medical lesson-icon text-yellow-600"></i>
                    </div>
                    <div class="md:w-2/3 text-center md:text-left">
                        <h3 class="text-2xl font-bold text-yellow-700 mb-2">ඉලක්කම් දෙකේ සංඛ්‍යා එකතු කිරීම (කැඩීම සමඟ) - Adding 2-digit Numbers (With Regrouping)</h3>
                        <p class="text-gray-700 text-lg">එකේ තැනේ ඉලක්කම් එකතු කරනකොට උත්තරේ 9ට වඩා වැඩි නම්, අපි දහයේ තැනට ඉලක්කමක් එකතු කරනවා (කැඩීම).</p>
                        <p class="text-gray-700 text-lg mt-2">When the sum of the ones digits is more than 9, we regroup and carry over to the tens place.</p>
                        <div class="flex justify-center md:justify-start gap-4 mt-4">
                            <div class="addition-problem-column">
                                <span class="text-sm font-normal text-gray-500 block mb-0">1</span>
                                <span class="block">38</span>
                                <span class="block">+ 24</span>
                                <span class="underline-problem"></span>
                                <span class="block">62</span>
                            </div>
                            <div class="addition-problem-column">
                                <span class="text-sm font-normal text-gray-500 block mb-0">1</span>
                                <span class="block">57</span>
                                <span class="block">+ 15</span>
                                <span class="underline-problem"></span>
                                <span class="block">72</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Concept 3: Addition of 3-digit numbers (without regrouping) -->
                <div class="flex flex-col md:flex-row items-center gap-6 p-6 bg-gray-50 rounded-lg shadow-sm">
                    <div class="md:w-1/3 flex justify-center items-center">
                        <i class="fas fa-calculator lesson-icon text-blue-600"></i>
                    </div>
                    <div class="md:w-2/3 text-center md:text-left">
                        <h3 class="text-2xl font-bold text-blue-700 mb-2">ඉලක්කම් තුනේ සංඛ්‍යා එකතු කිරීම (නොකැඩී) - Adding 3-digit Numbers (No Regrouping)</h3>
                        <p class="text-gray-700 text-lg">අපි එකේ තැනේ ඉඳන් සියයේ තැන දක්වා එකින් එක එකතු කරමු.</p>
                        <p class="text-gray-700 text-lg mt-2">We add from the ones place, then tens, then hundreds.</p>
                        <div class="flex justify-center md:justify-start gap-4 mt-4">
                            <div class="addition-problem-column">
                                <span class="block">123</span>
                                <span class="block">+ 214</span>
                                <span class="underline-problem"></span>
                                <span class="block">337</span>
                            </div>
                            <div class="addition-problem-column">
                                <span class="block">305</span>
                                <span class="block">+ 192</span>
                                <span class="underline-problem"></span>
                                <span class="block">497</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gamified Activity Section: Addition Speed Challenge -->
            <div class="text-center mt-12 p-8 bg-purple-50 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-purple-800 mb-6">විනෝදජනක ක්‍රීඩාව: එකතු කිරීමේ වේග අභියෝගය!</h2>
                <p class="text-purple-700 text-lg mb-4">ලබා දී ඇති ප්‍රශ්නවලට ඉක්මනින් නිවැරදි උත්තරය තෝරන්න!</p>

                <div id="speedChallengeGame">
                    <div class="game-header">
                        <div class="game-stat">ලකුණු: <span id="gameScore">0</span></div>
                        <div class="game-stat">වේලාව: <span id="gameTime">60</span>s</div>
                    </div>

                    <p id="problemStatement" class="problem-display">Start!</p>

                    <div id="optionsContainer" class="options-grid">
                        <!-- Options will be dynamically loaded here -->
                    </div>

                    <p id="gameMessage" class="game-feedback-message"></p>

                    <div class="game-control-buttons">
                        <button id="startGameBtn">ක්‍රීඩාව පටන් ගමු! (Start Game!)</button>
                        <button id="restartGameBtn" class="hidden">ආයෙත් පටන් ගමු! (Restart Game!)</button>
                    </div>
                </div>
            </div>

            <!-- Custom Modal for game alerts -->
            <div id="customModal" class="custom-modal">
                <div class="custom-modal-content">
                    <h3 id="modalTitle"></h3>
                    <p id="modalMessage"></p>
                    <button id="modalCloseBtn">හරි (OK)</button>
                </div>
            </div>

            <!-- Call to Action for Next Lesson/Quiz -->
            <div class="text-center mt-12 p-6 bg-green-50 rounded-lg shadow-md">
                <h3 class="text-2xl font-bold text-green-800 mb-4">ඔයා හරිම දක්ෂයි!</h3>
                <p class="text-green-700 text-lg mb-6">ඔයා එකතු කිරීම හොඳට ඉගෙනගත්තා! ඊළඟ පාඩමට යන්න සූදානම්ද?</p>
                <p class="text-gray-700 text-lg mb-6">You've learned addition well! Ready for the next lesson?</p>

                <a href="grade3_lesson3_subtraction.html" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg font-bold text-xl transition duration-300 shadow-lg hover:shadow-xl">
                    ඊළඟ පාඩම (Next Lesson) <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>

            <!-- Navigation between lessons -->
            <div class="flex justify-between mt-8">
                <a href="grade3_lesson1_numbers.html" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-medium transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i> කලින් පාඩම (Previous Lesson)
                </a>
                <a href="grade3_lesson3_subtraction.html" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition duration-300">
                    ඊළඟ පාඩම (Next Lesson) <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>

        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">MathLanka</h3>
                    <p class="text-gray-400">Making mathematics learning fun and effective for Sri Lankan students since 2025.</p>
                    <div class="flex space-x-4 mt-4">
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="../index.html" class="text-gray-400 hover:text-white">Home</a></li>
                        <li><a href="../index.html#features" class="text-gray-400 hover:text-white">Features</a></li>
                        <li><a href="../index.html#courses" class="text-gray-400 hover:text-white">Courses</a></li>
                        <li><a href="../index.html#games" class="text-gray-400 hover:text-white">Games</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white">Pricing</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Resources</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white">Blog</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white">Help Center</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white">Tutorials</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white">Practice Papers</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white">Scholarship Info</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Contact Us</h4>
                    <ul class="space-y-2">
                        <li class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>
                            <span class="text-gray-400">Math Lanka</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-phone-alt mr-2 text-gray-400"></i>
                            <span class="text-gray-400">+94 74 176 2872</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-envelope mr-2 text-gray-400"></i>
                            <span class="text-gray-400">info@mathlanka.lk</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2025 MathLanka. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Custom Modal for alerts (Replaces alert())
        function showCustomModal(title, message, callback) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            modal.classList.add('show');

            const closeBtn = document.getElementById('modalCloseBtn');
            const closeHandler = () => {
                modal.classList.remove('show');
                closeBtn.removeEventListener('click', closeHandler);
                if (callback) callback();
            };
            closeBtn.addEventListener('click', closeHandler);
        }

        // Mobile menu toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuButton = document.querySelector('button.md\\:hidden'); 
            const mobileMenu = document.createElement('div');
            mobileMenu.className = 'hidden fixed inset-0 bg-white z-50 flex flex-col items-center justify-center';
            mobileMenu.innerHTML = `
                <button class="absolute top-4 right-4 text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
                <div class="flex flex-col items-center space-y-6">
                    <a href="../index.html#features" class="text-gray-700 hover:text-blue-600 text-xl font-medium">Features</a>
                    <a href="../index.html#courses" class="text-gray-700 hover:text-blue-600 text-xl font-medium">Courses</a>
                    <a href="../index.html#games" class="text-gray-700 hover:text-blue-600 text-xl font-medium">Games</a>
                    <a href="../index.html#about" class="text-gray-700 hover:text-blue-600 text-xl font-medium">About</a>
                    <a href="../login.html" class="text-gray-700 hover:text-blue-600 text-xl font-medium">Login</a>
                    <a href="../signup.html" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium text-xl">Sign Up</a>
                </div>
            `;
            document.body.appendChild(mobileMenu);

            mobileMenuButton.addEventListener('click', function() {
                mobileMenu.classList.remove('hidden');
            });

            mobileMenu.querySelector('button').addEventListener('click', function() {
                mobileMenu.classList.add('hidden');
            });

            // --- Addition Speed Challenge Game Logic ---
            const gameScoreDisplay = document.getElementById('gameScore');
            const gameTimeDisplay = document.getElementById('gameTime');
            const problemStatementDisplay = document.getElementById('problemStatement');
            const optionsContainer = document.getElementById('optionsContainer');
            const gameFeedbackMessage = document.getElementById('gameMessage');
            const startGameButton = document.getElementById('startGameBtn');
            const restartGameButton = document.getElementById('restartGameBtn');

            let currentProblem = { num1: 0, num2: 0, sum: 0 };
            let score = 0;
            let timeLeft = 60; // seconds
            let gameInterval;
            let gameActive = false;

            function generateProblem() {
                let num1, num2, sum;
                // Randomly choose between 2-digit with/without regrouping or simple 3-digit
                const problemType = Math.floor(Math.random() * 3); // 0, 1, or 2

                if (problemType === 0) { // 2-digit without regrouping
                    num1 = Math.floor(Math.random() * 80) + 10; // 10-89
                    num2 = Math.floor(Math.random() * (99 - num1)) + 1; // Ensure sum < 100 and no regrouping in ones
                    if ((num1 % 10) + (num2 % 10) >= 10) { // If it causes regrouping, regenerate num2
                         num2 = Math.floor(Math.random() * (10 - (num1 % 10))) + 1;
                         if (num1 + num2 >= 100) num2 = 99 - num1; // Cap sum at 99
                    }
                } else if (problemType === 1) { // 2-digit with regrouping
                    num1 = Math.floor(Math.random() * 70) + 20; // 20-89
                    num2 = Math.floor(Math.random() * 70) + 20; // 20-89
                    // Ensure regrouping happens in ones
                    if ((num1 % 10) + (num2 % 10) < 10) {
                        num2 += (10 - ((num1 % 10) + (num2 % 10))) + Math.floor(Math.random() * 5); // Force regrouping
                    }
                } else { // 3-digit without regrouping (sums up to ~500)
                    num1 = Math.floor(Math.random() * 200) + 100; // 100-299
                    num2 = Math.floor(Math.random() * (499 - num1)) + 1; // Ensure sum < 500
                    // Ensure no regrouping for simplicity in this type
                    let onesSum = (num1 % 10) + (num2 % 10);
                    let tensSum = (Math.floor(num1 / 10) % 10) + (Math.floor(num2 / 10) % 10);
                    if (onesSum >= 10 || tensSum >= 10) {
                        // Simple way to avoid regrouping: pick smaller numbers for num2
                        num2 = Math.floor(Math.random() * (9 - (num1 % 10))) + 1 +
                               (Math.floor(Math.random() * (9 - (Math.floor(num1 / 10) % 10))) + 1) * 10 +
                               Math.floor(Math.random() * (4 - (Math.floor(num1 / 100)))) * 100;
                        num2 = Math.max(1, Math.min(num2, 500 - num1)); // Ensure valid range
                    }
                }
                sum = num1 + num2;
                currentProblem = { num1, num2, sum };
                problemStatementDisplay.textContent = `${num1} + ${num2} = ?`;
            }


            function generateOptions() {
                optionsContainer.innerHTML = ''; // Clear previous options
                let options = new Set();
                options.add(currentProblem.sum);

                while (options.size < 4) { // Generate 4 options (1 correct, 3 incorrect)
                    let distractor;
                    // Generate distractors close to the correct answer but not too far
                    const offset = Math.floor(Math.random() * 10) - 5; // -5 to +4 range
                    distractor = currentProblem.sum + offset;
                    if (distractor < 0) distractor = Math.abs(distractor) + 1; // Ensure positive

                    // Add more diverse distractors for larger numbers
                    if (currentProblem.sum > 50) {
                        distractor = Math.floor(Math.random() * 100) + (currentProblem.sum - 50);
                    }

                    // Ensure distractor is not the correct answer and is unique among options
                    if (distractor !== currentProblem.sum && !options.has(distractor)) {
                        options.add(distractor);
                    }
                }

                Array.from(options).sort(() => Math.random() - 0.5).forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = option;
                    button.dataset.value = option;
                    button.addEventListener('click', handleOptionClick);
                    optionsContainer.appendChild(button);
                });
            }

            function handleOptionClick(event) {
                if (!gameActive) return;

                const selectedValue = parseInt(event.target.dataset.value);
                const allButtons = optionsContainer.querySelectorAll('.option-button');

                // Temporarily disable all buttons to prevent multiple clicks
                allButtons.forEach(btn => btn.disabled = true);

                if (selectedValue === currentProblem.sum) {
                    score += 10;
                    gameScoreDisplay.textContent = score;
                    gameFeedbackMessage.textContent = 'නියමයි! (Correct!)';
                    gameFeedbackMessage.style.color = '#10b981'; // green-600
                    event.target.classList.add('correct-feedback');
                } else {
                    score = Math.max(0, score - 5); // Deduct points, but not below zero
                    gameScoreDisplay.textContent = score;
                    gameFeedbackMessage.textContent = `වැරදියි! හරි උත්තරේ ${currentProblem.sum} (Incorrect! Correct answer is ${currentProblem.sum})`;
                    gameFeedbackMessage.style.color = '#dc2626'; // red-600
                    event.target.classList.add('incorrect-feedback');
                    // Highlight correct answer
                    optionsContainer.querySelectorAll('.option-button').forEach(btn => {
                        if (parseInt(btn.dataset.value) === currentProblem.sum) {
                            btn.classList.add('correct-feedback');
                        }
                    });
                }

                setTimeout(() => {
                    gameFeedbackMessage.textContent = '';
                    allButtons.forEach(btn => {
                        btn.disabled = false; // Re-enable for next problem
                        btn.classList.remove('correct-feedback', 'incorrect-feedback');
                    });
                    if (gameActive) { // Only generate new problem if game is still active
                        generateProblem();
                        generateOptions();
                    }
                }, 1000); // Short delay for feedback
            }

            function startGame() {
                if (gameActive) return; // Prevent starting if already active

                score = 0;
                timeLeft = 60;
                gameActive = true;
                gameScoreDisplay.textContent = score;
                gameTimeDisplay.textContent = timeLeft;
                gameFeedbackMessage.textContent = '';
                startGameButton.classList.add('hidden');
                restartGameButton.classList.remove('hidden');

                generateProblem();
                generateOptions();

                gameInterval = setInterval(() => {
                    timeLeft--;
                    gameTimeDisplay.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        endGame();
                    }
                }, 1000);
            }

            function endGame() {
                gameActive = false;
                clearInterval(gameInterval);
                gameFeedbackMessage.textContent = ''; // Clear temporary message

                // Disable all options at end of game
                optionsContainer.querySelectorAll('.option-button').forEach(btn => btn.disabled = true);

                showCustomModal('ක්‍රීඩාව අවසන්! (Game Over!)', `ඔබේ අවසන් ලකුණු: ${score}. තවත් පුහුණු වෙමු! (Your final score: ${score}. Let's practice more!)`);
            }

            // Event Listeners
            startGameButton.addEventListener('click', startGame);
            restartGameButton.addEventListener('click', startGame); // Restart also calls startGame to reset

            // Initial state (optional, can be done with HTML directly)
            gameScoreDisplay.textContent = 0;
            gameTimeDisplay.textContent = 60;
            problemStatementDisplay.textContent = 'පටන් ගනිමු!'; // "Let's start!"
        });
    </script>
</body>
</html>
